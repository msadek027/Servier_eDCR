@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="~/AdminLTE/plugins/jQuery/jquery-2.2.3.min.js"></script>
<link href="~/Content/CustomCSS/InputText.css" rel="stylesheet" />
<link href="~/Content/CustomCSS/exportPDF.css" rel="stylesheet" />
<script src="~/Scripts/CustomJS/DefaultValue.js"></script>

@*<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>*@

<!--
<style>
    /* BASICS: */
    * {
        padding: 0;
        margin: 0;
        box-sizing: border-box; /* in case block elements are used inside table cells */
    }
    html {
        font-size: 62.5%; /* standardizes older IEs */
    }
    body {
        font: normal 1.3em Verdana; /* = 13px */
        padding: 1px;
    }
    table {
        border-collapse: collapse;
        table-layout: fixed;
        width: 100%;
    }
    td {
        border: 1px solid black;
        /*padding: 4px;*/
    }
    /* SCROLL TABLE ESSENTIALS (+ SOME ADDITIONAL CSS): */
    div#scrollTableContainer {
        width: 100%;
        table-layout: fixed;
        /*margin: 5px;*/ /* just for presentation purposes */
        /*border: 1px solid black;*/
    }
    .touchScreen div#scrollTableContainer {
        width: 100%; /* touch devices do not form scrollbars (= 17 px wide) */
    }
    #tHeadContainer {
        background: #666633;
        color: white;
        font-size: small;
        text-align: center;
        width: 99%;
        /*table-layout: fixed;*/
    }
    #tBodyContainer {
        min-height: 300px;
        max-height: 450px;
        width: 100%;
        overflow-y: scroll;
        font-size: small;
        text-align: center;
        overflow-x: hidden;
        table-layout: fixed;
    }
    .touchScreen #tBodyContainer {
        -webkit-overflow-scrolling: touch; /* smooths scrolling on touch screens */
    }
    /* FINER LAYOUT MATTERS: */
    tr:first-child td {
        border-top: 0;
    }
    #tBody tr.lastRow td {
        border-bottom: 0;
    }
    /* AND SOME CSS TO INFORM TOUCH SCREEN USERS: */
    p#touchDeviceText {
        display: none;
    }
    .touchScreen p#touchDeviceText {
        display: block;
    }
    .SL {
        width: 2%;
    }
    .Date {
        width: 8%;
    }
    .DoctorID {
        width: 6%;
    }
    .DoctorName {
        width: 10%;
    }
    .MarketName {
        width: 8%;
    }
    .Item {
        width: 10%;
    }
    .ShiftName {
        width: 3%;
    }
    .Accompany {
        width: 6%;
    }
    .Remark {
        width: 6%;
    }
    tr.group {
        border-top: 2px solid red;
    }
</style>
    -->

<script>
    $(document).ready(function () {
        $.ajaxSetup({
            beforeSend: function () {
                $("#divLoading").show();
            },
            complete: function () {
                $("#divLoading").hide();
            }
        });

        EventPermission();
        LoadRegion();
        function LoadRegion() {
            $.ajax({
                url: '/Default/GetRegion',
                type: 'get',
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $.each(data, function (i, item) {
                     
                        if (i === 0) {
                            if (data.length > 1) {
                                $('#RegionCode').append('<option value="" selected="selected"></option>');
                            }
                            LoadTM(item.RegionCode);
                        }
                        $('#RegionCode').append($('<option>', { value: item.RegionCode, html: item.RegionName }, '<option/>'));
                        $('#RegionName').val(item.RegionName);
                    });
                },
                error: function () {
                    alert("Failed to load...");
                }
            });
        }
        $('#RegionCode').on('change', function () {
            LoadTM($(this).val());
            $('#RegionName').val($("#RegionCode option:selected").text());
        }).trigger('change');;

        function LoadTM(RegionCode) {
            $.ajax({
                url: '/Default/GetTerritoryFromRegion',
                data: { RegionCode: RegionCode },
                type: 'Post',
                dataType: 'json',
                success: function (data) {
                    $('#TerritoryManagerID').empty();
                    $.each(data, function (i, item) {

                        if (i === 0) {
                            if (data.length > 1) {
                                $('#TerritoryManagerID').append('<option value="" selected="selected"></option>');
                            }
                            LoadMPO(item.TerritoryManagerID);
                            $('#TerritoryManagerName').val(item.TerritoryManagerName);
                        }
                        $('#TerritoryManagerID').append($('<option>', { value: item.TerritoryManagerID, html: item.TerritoryManagerName }, '<option/>'));

                    });
                },
                error: function () {
                    alert("Failed to load...");
                }
            });
        }



        $('#TerritoryManagerID').on('change', function () {
            LoadMPO($(this).val());
            $('#TerritoryManagerName').val($("#TerritoryManagerID option:selected").text());
        }).trigger('change');;




        function LoadMPO(TerritoryManagerID) {

            $.ajax({
                url: '/Default/GetMPOPopupList',
                data: { TerritoryManagerID: TerritoryManagerID },
                type: 'Post',
                dataType: 'json',
                success: function (data) {
                    $('#MPGroup').empty();
                    $.each(data, function (i, item) {
                        if (i == 0) {
                            $('#MPGroup').append('<option value="" selected="selected"></option>');
                            $('#MPOName').val(item.MPOName);
                        }
                        $('#MPGroup').append($('<option>', { value: item.MPGroup, html: item.MPOName }, '<option/>'));

                    });
                },

                error: function () {
                    alert("Failed to load...");
                }
            });

        }
        LoadTM($("#RegionCode").val());
        LoadMPO($("#TerritoryManagerID").val());

        $('#MPGroup').on('change', function () {
            $('#MPOName').val($("#MPGroup option:selected").text());
        }).trigger('change');;
        $("#TerritoryManagerID,#MPGroup").on('change', function (e) {
            $('#tBody').html('');

        });

        $('#btnReset').click(function () {
            ResetData();
            $(":checkbox").prop('checked', true);
            $("#IsActive").click();
        });



        $('#IsActive').click(function () {
            if ($(this).is(':checked')) {
                $(this).siblings('label').html('Unhide');
                $('#divValueParameter').hide();
            }
            else {
                $(this).siblings('label').html('Hide');
                $('#divValueParameter').show();
            }
        });


    
        $('#btnView').click(function () {

            $('#tBody').html('');
            $("body").addClass('sidebar-collapse').trigger('collapsed.pushMenu');

            $('#MainGrid').data('kendoGrid').dataSource.filter([]);
            $('#MainGrid').data('kendoGrid').dataSource.data([]);
            var FromDate = $("#FromDate").val();
            var ToDate = $("#ToDate").val();
            var fromDateParts = FromDate.split("-");
            var fromDateObject = new Date(fromDateParts[2], fromDateParts[1] - 1, fromDateParts[0]);

            var toDateParts = ToDate.split("-");
            var toDateObject = new Date(toDateParts[2], toDateParts[1] - 1, toDateParts[0]);

            if (fromDateObject > toDateObject) {
                $('#FromDate').css("border", "1px solid red");
                $('#ToDate').css("border", "1px solid red");
                $('#ToDate').val("");
                toastr.warning("To Date cannot be greater than From Date");
                return false;
            }

            var model = {};

            model.FromDate = FromDate;
            model.ToDate = ToDate;
            model.TerritoryManagerID = $("#TerritoryManagerID").val();
            model.RegionCode = $("#RegionCode").val();
            model.MPGroup = $("#MPGroup").val();
           // var Input = InputValidation('FromDate') + InputValidation('ToDate') + InputValidation('RegionCode');
            var Input = InputValidation('FromDate') + InputValidation('ToDate');
            if (Input == 0) {
                MainGridView(model);
            }
            else {
                ValidationMsg();
                toastr.warning($("#MessageText").html());
            }
        });
        $("#MainGrid").kendoGrid({
            dataSource: new kendo.data.DataSource({
                batch: false,
                schema: {
                    model: {
                        id: "DayNumber",
                        fields: {
                            DayNumber: { type: "string" },
                            MarketName: { type: "string" },
                            Date: { type: "string" },
                            DoctorID: { type: "string" },
                            DoctorName: { type: "string" },
                            PlanSelected: { type: "string" },
                            PlanSample: { type: "string" },
                            PlanGift: { type: "string" },
                            DCRSelected: { type: "string" },
                            DCRSample: { type: "string" },
                            DCRGift: { type: "string" },

                            ShiftName: { type: "string" },
                            Accompany: { type: "string" },
                            DcrType: { type: "string" },
                            Remarks: { type: "string" },
                        }
                    }
                },
                //serverPaging: true,
                //serverSorting: true,
                pageSize: 100,
                
            }),
           // pageable: true,
            pageable: {
                pageSizes: true, buttonCount: 10
            },
            dataBound: function (e) {
                AutoFitColumn(this.element[0].id);
            },
            toolbar: [{ template: "<input type='text' id='txtGridDoctorName'  style='float:right' placeholder='Doctor Name...' class='k-textbox'>" },{ template: "<input type='text' id='txtGridDoctorId'  style='float:right' placeholder='DoctorId...' class='k-textbox'>" },],
            navigatable: true,
            height: 450,
            scrollable:true,
            sortable: true,
            filterable: false,
            editable: false,
           
            columnMenu: false,
            reorderable: false,
            //resizable: true,
            //resize: function (e) {
            //    this.table.height(this.element.height() + this.table.height() - 1);
            //},
            columns: [
                { field: "SL", title: "SL", width: 30, locked: true },
                { field: "MarketName", title: "Market<br/>Name", width: 100, locked: true },
                { field: "Date", title: "Date", width: 80 },
                { field: "DoctorID", title: "Doctor<br/>ID", width: 70 },
                { field: "DoctorName", title: "Doctor<br/>Name", width: 120},
                { title: "PLAN", headerAttributes: { "class": "gridHeader", style: "font-weight: bold;font-size: 10px;text-align: center;" },
                    columns: [
                        { field: "PlanSelected", title: "Plan<br/>Selected", width: 150 },
                        { field: "PlanSample", title: "Plan<br/>Sample", width: 150 },
                        { field: "PlanGift", title: "Plan<br/>Material", width: 120 },
                    ]
                },
                {
                    title: "DCR", headerAttributes: { "class": "gridHeader", style: "font-weight: bold;font-size: 10px;text-align: center;" },
                    columns: [
                        { field: "DCRSelected", title: "DCR<br/>Selected", width: 150 },
                        { field: "DCRSample", title: "DCR<br/>Sample", width: 150 },
                        { field: "DCRGift", title: "DCR<br/>Material", width: 120 },
                    ]
                },
                { field: "ShiftName", title: "Shift", width: 50, },
                { field: "Accompany", title: "Accompany", width: 100, },
                { field: "DcrType", title: "DCR Type", width: 100, },
                { field: "Remarks", title: "Remarks", width: 120, },
            ],
        });

        $("#txtGridDoctorId").keyup(function () {
            var val = $(this).val();
            $("#MainGrid").data("kendoGrid").dataSource.filter({
                logic: "or",
                filters: [
                    { field: "DoctorID", operator: "contains", value: val },                
                ]
            });
        });
        $("#txtGridDoctorName").keyup(function () {
            var val = $(this).val();
            $("#MainGrid").data("kendoGrid").dataSource.filter({
                logic: "or",
                filters: [
                    { field: "DoctorName", operator: "contains", value: val },
                ]
            });
        });
        function MainGridView(model) {

            $.ajax({
                type: "POST",
                url: "/ReportDCRPlanVsExecution/GetMainGrid",
                data: JSON.stringify({ model: model }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.length > 0) {
                        $("#MainGrid").data("kendoGrid").dataSource.data(data);
                    }
                    else {
                        AcknowledgeMsg();
                        toastr.info($("#MessageText").html());
                    }                  
                   
                },
                error: function () {
                    ErrorFrmClientMsg();
                    toastr.warning($("#MessageText").html());
                },
            });

        }
        function groupRows() {
            var last = null;
            $("#tBody tbody tr td:nth-child(1)").each(function () {
                if ((last) && (last != this.innerText)) {
                    $(this).parent().addClass("group");
                }
                last = this.innerText;
            });
        }



        function groupTable($rows, startIndex, total) {
            if (total === 0) {
                return;
            }
            var i, currentIndex = startIndex, count = 1, lst = [];
            var tds = $rows.find('td:eq(' + currentIndex + ')');
            var ctrl = $(tds[0]);
            lst.push($rows[0]);
            for (i = 1; i <= tds.length; i++) {
                if (ctrl.text() == $(tds[i]).text()) {
                    count++;
                    $(tds[i]).addClass('deleted');
                    lst.push($rows[i]);
                }
                else {
                    if (count > 1) {
                        ctrl.attr('rowspan', count);
                        groupTable($(lst), startIndex + 1, total - 1)
                    }
                    count = 1;
                    lst = [];
                    ctrl = $(tds[i]);
                    lst.push($rows[i]);
                }
            }
        }






    });
</script>


<div class="box-header with-border">

    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

            <form class="form" action="/ReportDCRPlanVsExecution/Export" id="R1Form" method="post" name="H1Form" target="_blank">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2"><div id="MessageText"></div></div>
                    <div class="col-xs-0 col-sm-0 col-md-10 col-lg-10">
                        <div style="text-align:right;">
                            <input type="checkbox" id="IsActive" class="chk" name="IsActive"> <label for="IsActive"> Hide</label>
                            <button id="btnExcel" class="btn btn-primary btn-sm" name="ExportType" value="Excel" type="submit"><i class="glyphicon glyphicon-envelope"></i> Excel </button>
                            <button id="btnPDF" class="btn btn-primary btn-sm" name="ExportType" value="PDF" type="submit"><i class="glyphicon glyphicon-book"></i> PDF </button>
                            <button id="btnView" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-file"></i> View</button>
                        </div>
                    </div>
                 </div>
                        <div class="box-body">
                            <div class="row" id="divValueParameter">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2">Date Between:</div>
                                    <div class="col-xs-0 col-sm-0 col-md-4 col-lg-4">
                                        <div class="input-group">
                                            <input type="text" id="FromDate" name="FromDate" class="date RequiredField form-control">
                                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span> </span>
                                            <span class="input-group-btn" style="width:0px;"></span>
                                            <input type="text" id="ToDate" name="ToDate" class="date RequiredField form-control">
                                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span> </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2">Region Name :</div>
                                    <div class="col-xs-0 col-sm-0 col-md-4 col-lg-4">
                                        <select id="RegionCode" name="RegionCode" class="RequiredField form-control"></select>
                                        <input type="hidden" id="RegionName" name="RegionName" class="RequiredField form-control">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2">Supervisor :</div>
                                    <div class="col-xs-0 col-sm-0 col-md-4 col-lg-4">
                                        <select id="TerritoryManagerID" name="TerritoryManagerID" class="RequiredField form-control"></select>
                                        <input type="hidden" id="TerritoryManagerName" name="TerritoryManagerName" class="RequiredField form-control">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2">FF Name :</div>
                                    <div class="col-xs-0 col-sm-0 col-md-4 col-lg-4">
                                        <select id="MPGroup" name="MPGroup" class="RequiredField form-control"></select>
                                        <input type="hidden" id="MPOName" name="MPOName" class="RequiredField form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
</form>
        </div>

        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div id="MainGrid" class="MainGrid"></div>
            </div>
        </div>


    </div>
    <div class="row" hidden>
        <div id="scrollTableContainer">
            <div id="tHeadContainer">
                <table id="tHead">
                    <tr>
                        <td class="SL"></td>
                        <td class="MarketName"></td>
                        <td class="Date"></td>
                        <td class="DoctorID"></td>
                        <td class="DoctorName"></td>
                        <td colspan="3">PLAN </td>
                        <td colspan="3">DCR</td>

                        <td class="ShiftName"></td>
                        <td class="Accompany"></td>
                        <td class="Remark"></td>



                    </tr>
                    <tr>
                        <td class="SL">SL</td>
                        <td class="MarketName">Market<br />Name</td>
                        <td class="Date">Date</td>
                        <td class="DoctorID">Doctor<br />ID</td>
                        <td class="DoctorName">Doctor<br />Name</td>

                        <td class="Item">Selected<br />Item</td>
                        <td class="Item">Sample<br />Item</td>
                        <td class="Item">Material<br />Item</td>

                        <td class="Item">Selected<br />Item</td>
                        <td class="Item">Sample<br />Item</td>
                        <td class="Item">Material<br />Item</td>


                        <td class="ShiftName">Shift</td>
                        <td class="Accompany">Accompany</td>
                        <td class="Remark">Remark</td>




                    </tr>
                </table>
            </div><!-- tHeadContainer -->
            <div id="tBodyContainer">
                <table id="tBody"></table>

            </div><!-- tBodyContainer -->
        </div><!-- scrollTableContainer -->
    </div>



    <div id="divLoading" style="margin: 0px; padding: 0px; position: fixed; right: 0px; top: 0px; width: 100%; height: 100%; background-color: #666666; z-index: 30001; opacity: .8; filter: alpha(opacity=70);display:none">
        <p style="position: absolute; top: 50%; left: 50%; color: White;"> <img src="~/Content/Images/loading.gif" /> </p>
    </div>
</div>


