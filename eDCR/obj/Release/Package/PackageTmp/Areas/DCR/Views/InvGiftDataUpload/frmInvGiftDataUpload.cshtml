@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="box-header with-border">

    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2"><div id="MessageText"></div></div>
        <div class="col-xs-0 col-sm-0 col-md-10 col-lg-10">
            <div style="text-align:right;">
                <button id="btnTemplateDownload" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-refresh"></i> Template</button>
                <button id="btnReset" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-refresh"></i> Reset</button>
                <button id="btnDelete" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-remove"></i>Delete</button>
                <button id="btnSaveAll" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-save-file"></i> Save All</button>
                <button id="btnExcel" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-envelope"></i> Excel </button>
                <button id="btnView" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-file"></i> View</button>
            </div>
        </div>

            </div>
        </div>
        <div class="box-body">

            <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2">Gift Code :</div>
                <div class="col-xs-0 col-sm-0 col-md-3 col-lg-3">
                    <input type="text" id="ProductCode" name="ProductCode" class="RequiredField form-control">
                </div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2"> </div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2">Gift Name :</div>
                <div class="col-xs-0 col-sm-0 col-md-3 col-lg-3">
                    <input type="text" id="ProductName" name="ProductName" class="RequiredField form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2">Hilighting Product :</div>
                <div class="col-xs-0 col-sm-0 col-md-3 col-lg-3">
                    <input type="text" id="HilightingProduct" name="HilightingProduct" class="RequiredField form-control">
                </div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2"> </div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2">SBU/Group :</div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2">
                    <select id="SBU" name="SBU" class="RequiredField form-control">
                        <option value=""></option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="N">N</option>
                        <option value="HB">HB</option>

                    </select>

                </div>
                <div class="col-xs-0 col-sm-0 col-md-1 col-lg-1">
                    <select id="MarketGroup" name="MarketGroup" class="RequiredField form-control">
                        <option value="R1">R1</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2">Cost Per Unit:</div>
                <div class="col-xs-0 col-sm-0 col-md-3 col-lg-3">
                    <input type="number" id="CostPerUnit" name="CostPerUnit" class="RequiredField form-control">
                </div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2"> </div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2"></div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2">
                    <button id="btnSaveSingle" class="btn btn-primary btn-sm" type="button"><i class="glyphicon glyphicon-save-file"></i> Save Single</button>
                </div>
            </div>
            <br />
            <br />
          
            <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-2 col-lg-2"><label for="myfile">Select a file:</label></div>
                <div class="col-xs-0 col-sm-0 col-md-3 col-lg-3">
                    <input type="file" id="myfile" name="myfile" class="files btn btn-primary btn-sm" accept=".xlsx"><br><br>

                </div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2"></div>
                <div class="col-xs-0 col-sm-0 col-md-2 col-lg-2"></div>
                <div class="col-xs-0 col-sm-0 col-md-3 col-lg-3"></div>
            </div>

            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div id="MainGrid" class="MainGrid"></div>
                </div>
            </div>

        </div>

        <div id="divLoading" style="margin: 0px; padding: 0px; position: fixed; right: 0px;
    top: 0px; width: 100%; height: 100%; background-color: #666666; z-index: 30001;
    opacity: .8; filter: alpha(opacity=70);display:none">
            <p style="position: absolute; top: 50%; left: 50%; color: White;">
                <img src="~/Content/Images/loading.gif" />
            </p>
        </div>
        <script src="~/AdminLTE/plugins/jQuery/jquery-2.2.3.min.js"></script>
        <link href="~/Content/CustomCSS/InputText.css" rel="stylesheet" />

        <script src="~/Scripts/xlsx_0.7.12_xlsx.full.min.js"></script>
        <script type="text/javascript">
            //// Start  $(document).ready(function ()
            $(document).ready(function () {

                $.ajaxSetup({
                    beforeSend: function () {
                        $("#divLoading").show();
                    },
                    complete: function () {
                        $("#divLoading").hide();
                    }
                });


                //upload change event
                $("#myfile").change(function (evt) {
                    var file = evt.target.files[0] //retrieve the uploaded file
                    fnConvertExcelToJSON(file)
                })
                function fnConvertExcelToJSON(file) { //method to convert excel to json
                    var reader = new FileReader()
                    reader.onload = function (event) {
                        var data = event.target.result
                        var workbook = XLSX.read(data, {
                            type: 'binary'
                        });
                        var json_object
                        workbook.SheetNames.forEach(function (sheetName) {
                            var XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName])
                            json_object = JSON.stringify(XL_row_object)
                            var jsonOutput = JSON.stringify(JSON.parse(json_object), undefined, 4)
                            // $('#jsonText').html(jsonOutput);
                            //  alert(jsonOutput.length);
                            var obj = JSON.parse(jsonOutput);
                            $("#MainGrid").data("kendoGrid").dataSource.data(obj);
                        })
                    }
                    reader.onerror = function (event) {
                        console.error("File could not be read! Code " + event.target.error.code)
                    }
                    reader.readAsBinaryString(file);
                }

                EventPermission();
                $('#btnReset').click(function () {



                    $('#MainGrid').data('kendoGrid').dataSource.filter([]);
                    $('#MainGrid').data('kendoGrid').dataSource.data([]);


                    $("#files").val('');
                    $(".txtBox").css("border-color", "");
                    $(".k-upload-files").remove();
                    $(".k-upload-status").remove();
                    $(".k-upload.k-header").addClass("k-upload-empty");
                    $(".k-upload-button").removeClass("k-state-focused");
                    ResetData();


                });
                $('#btnTemplateDownload').click(function () {
                    $.ajax({
                        url: '/InvGiftDataUpload/TemplateDownload',
                        method: 'POST',
                        data: JSON.stringify({}),
                        dataType: 'JSON',
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            if (data != "") {
                                window.location.href = "/InvGiftDataUpload/Download/?fileName=" + data.fileName;
                            }
                            else {
                                AcknowledgeMsg();
                                toastr.warning($("#MessageText").html());
                            }

                        },
                        error: function () {
                            alert('Error occured!');
                        },
                    });
                });
                $('#btnExcel').click(function () {
                    $("#MainGrid").getKendoGrid().saveAsExcel();
                });
                //***************view function*****************
                $('#btnView').click(function () {
                    $('#MainGrid').data('kendoGrid').dataSource.filter([]);
                    $('#MainGrid').data('kendoGrid').dataSource.data([]);

                    var model = {};
                    $.ajax({
                        type: "POST",
                        url: "/InvGiftDataUpload/GetGridData",
                        data: JSON.stringify({ model: model }),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (data) {
                            if (data != null) {

                                $("#MainGrid").data("kendoGrid").dataSource.data(data);

                            }
                            else {
                                AcknowledgeMsg();
                                toastr.warning("No Record Found!");

                            }
                        },

                    });

                });



                //Initializing Main page details Kendo Grid Colums
                var MainGrid = $('#MainGrid').kendoGrid({
                    dataSource: new kendo.data.DataSource({
                        batch: true,
                        schema: {
                            model: {
                                id: "ProductCode",
                                fields: {
                                    ProductCode: { type: "string" },
                                    ProductName: { type: "string" },
                                    HilightingProduct: { type: "string" },
                                    MarketGroup: { type: "string" },
                                    SBU: { type: "string" },
                                    CostPerUnit: { type: "string" },
                                }
                            }
                        },
                        pageSize: 10,
                    }),
                    pageable: {
                        //refresh: true,
                        pageSizes: true, buttonCount: 5
                    },
                    dataBound: function (e) {
                        AutoFitColumn(this.element[0].id);
                    },
                    edit: function (e) {
                        $('input[name = "ProductCode"]').attr("readonly", true);
                        $('input[name = "ProductName"]').attr("readonly", true);

                    },
                    scrollable: true,
                    sortable: true,
                    filterable: false,
                    editable: false,
                    selectable: "row",
                    //selectable: "multiple",
                    toolbar: [{ template: "<input type='text' id='txtInput'  style='float:right' placeholder='Search...' class='k-textbox'>" },],
                    excel: {
                        fileName: "InvGift.xlsx",
                        allPages: true,
                        filterable: true
                    },
                    navigatable: true,
                    //height: 120,
                    //groupable: true,
                    //groupable: { messages: { empty: "Tour Plan" } },
                    columnMenu: false,
                    reorderable: false,
                    resizable: false,
                    resize: function (e) {
                        var tableH = this.element.height();
                        var bodyH = this.table.height();
                        this.table.height(tableH + bodyH - 1);
                    },
                    columns: [
                        { field: "ProductCode", hidden: false, title: "ProductCode" },
                        { field: "ProductName", hidden: false, title: "ProductName" },
                        { field: "HilightingProduct", hidden: false, title: "HilightingProduct" },
                        { field: "MarketGroup", hidden: false, title: "MarketGroup" },
                        { field: "SBU", hidden: false, title: "SBU" },
                        { field: "CostPerUnit", hidden: false, title: "CostPerUnit" },

                        { command: [{ name: "DeletedRow", text: "Remove", imageClass: "k-icon k-i-close", click: handleGiftRemove }], title: "Remove", headerAttributes: { "class": "gridHeader", style: "font-weight: bold;font-size: 13px;text-align: center;" } }
                    ]
                }).data('kendoGrid');


                function handleGiftRemove(event) {
                    event.preventDefault();
                    dataitem = MainGrid.dataItem($(event.currentTarget).closest("tr"));
                    MainGrid.dataSource.remove(dataitem);
                };


                $("#txtInput").keyup(function () {
                    var val = $(this).val();
                    $("#MainGrid").data("kendoGrid").dataSource.filter({
                        logic: "or",
                        filters: [
                            { field: "ProductCode", operator: "contains", value: val },
                            { field: "ProductName", operator: "contains", value: val },


                        ]
                    });
                });





                var gridInput = 0;
                function GridValidation() {
                    gridInput = 0;



                    var detailData = $('#MainGrid').data("kendoGrid").dataSource;
                    var detailDataList = detailData.data();
                    if (detailDataList.length > 0) {
                        for (var i = 0; i < detailDataList.length; i++) {
                            if (detailDataList[i].ProductCode == "") {
                                gridInput = 1;
                            }

                        }
                    }
                    else {
                        gridInput = 1;
                    }

                }

                var model = { "ItemList": [] };

                $('#btnSaveAll').click(function () {
                    GridValidation();
                    model.ItemList = [];

                    if (gridInput == 0) {

                        var dataSource = $("#MainGrid").data("kendoGrid").dataSource;
                        var filters = dataSource.filter();
                        var allData = dataSource.data();
                        var query = new kendo.data.Query(allData);
                        var data = query.filter(filters).data;


                        var dataSource = $("#MainGrid").data("kendoGrid").dataSource;
                        var filters = dataSource.filter();
                        var allData = dataSource.data();
                        var query = new kendo.data.Query(allData);
                        var data = query.filter(filters).data;

                        if (data.length > 0) {

                            for (var i = 0; i < data.length; i++) {
                                var detail = {};
                                detail.ProductCode = data[i].ProductCode;
                                detail.ProductName = data[i].ProductName;
                                detail.HilightingProduct = data[i].HilightingProduct;
                                detail.MarketGroup = data[i].MarketGroup;
                                detail.SBU = data[i].SBU;
                                detail.CostPerUnit = data[i].CostPerUnit;
                                model.ItemList.push(detail);

                            }
                        }

                        $.ajax({
                            url: '/InvGiftDataUpload/OperationsMode',
                            data: JSON.stringify({ model: model }),
                            type: 'POST',
                            contentType: 'application/json;',
                            dataType: 'json',
                            success: function (data) {
                                if (data.Status == "Yes") {
                                    OperationMsg(data.Mode);
                                    toastr.success($("#MessageText").html());
                                }
                                else {
                                    ErrorFrmServerMsg(data.Status);
                                    toastr.warning($("#MessageText").html());
                                }

                            },
                            error: function (xhr, status, error) {
                                alert(xhr.responseText);
                            }
                            // complete: function () { CompletedMsg(); },
                        }); //End of ajax call

                        //var dataSource = $("#MainGrid").data("kendoGrid").dataSource;
                        //var filters = dataSource.filter();
                        //var allData = dataSource.data();
                        //var query = new kendo.data.Query(allData);
                        //var data = query.filter(filters).data;

                        //var dt = $("#MainGrid").data().kendoGrid._data;


                        //$.ajax({
                        //    url: '/ItemDataUpload/OperationsMode2',
                        //    cache: false,
                        //    type: 'POST',
                        //    contentType: 'application/json; charset=utf-8',
                        //    data: JSON.stringify($("#MainGrid").data().kendoGrid._data)
                        // });


                    }

                    else {
                        ValidationMsg();
                        toastr.warning($("#MessageText").html());
                    }

                });
                $('#btnSaveSingle').click(function () {

                    var Input = InputValidation('ProductCode') + InputValidation('ProductName') + InputValidation('HilightingProduct') + InputValidation('SBU') + InputValidation('MarketGroup');
                    if (Input == 0) {

                        model.ItemList = [];
                        var detail = {};
                        detail.ProductCode = $("#ProductCode").val();
                        detail.ProductName = $("#ProductName").val();
                        detail.HilightingProduct = $("#HilightingProduct").val();

                        detail.SBU = $("#SBU").val();
                        detail.MarketGroup = $("#MarketGroup").val();
                        detail.CostPerUnit = $("#CostPerUnit").val();
                        model.ItemList.push(detail);
                        $.ajax({
                            url: '/InvGiftDataUpload/OperationsMode',
                            data: JSON.stringify(model),
                            type: 'POST',
                            contentType: 'application/json;',
                            dataType: 'json',
                            success: function (data) {
                                if (data.Status == "Yes") {
                                    //$("#FormID").val(data.ID);
                                    OperationMsg(data.Mode);
                                    toastr.success($("#MessageText").html());
                                }
                                else {
                                    ErrorFrmServerMsg(data.Status);
                                    toastr.warning($("#MessageText").html());
                                }

                            },
                            error: function () {
                                ErrorFrmClientMsg();
                                toastr.warning($("#MessageText").html());
                            },
                            // complete: function () { CompletedMsg(); },
                        }); //End of ajax call

                        //}
                    }

                    else {
                        ValidationMsg();
                        toastr.warning($("#MessageText").html());
                    }
                });
                $('#btnDelete').click(function () {

                    var model = {};
                    var Input = InputValidation('ProductCode') + InputValidation('SBU') + InputValidation('MarketGroup');


                    if (Input == 0) {

                        model.ItemList = [];
                        var detail = {};
                        detail.ProductCode = $("#ProductCode").val();
                        detail.ProductName = $("#ProductName").val();
                        detail.HilightingProduct = $("#HilightingProduct").val();

                        detail.SBU = $("#SBU").val();
                        detail.MarketGroup = $("#MarketGroup").val();
                        detail.CostPerUnit = $("#CostPerUnit").val();
                        model.ItemList.push(detail);


                        $.ajax({
                            url: '/InvGiftDataUpload/OperationsDeleteMode',
                            data: JSON.stringify({ model: model }),
                            type: 'POST',
                            contentType: 'application/json;',
                            dataType: 'json',
                            success: function (data) {
                                if (data.Status == "Yes") {
                                    OperationMsg(data.Mode);
                                    toastr.success($("#MessageText").html());
                                }
                                else {
                                    ErrorFrmServerMsg(data.Status);
                                    toastr.warning($("#MessageText").html());
                                }

                            },
                            error: function (xhr, status, error) {
                                alert(xhr.responseText);
                            }
                            // complete: function () { CompletedMsg(); },
                        }); //End of ajax call

                    }

                    else {
                        ValidationMsg();
                        toastr.warning($("#MessageText").html());
                    }
                });
                $("#MainGrid").click(function () {

                    var gridData = $("#MainGrid").data("kendoGrid");
                    var selectedItem = (gridData.dataItem(gridData.select())); //Selected Row

                    // var selectedItem = MainGrid.dataItem($(e.currentTarget).closest("tr"));

                    $("#ProductCode").val(selectedItem.ProductCode);
                    $("#ProductName").val(selectedItem.ProductName);
                    $("#HilightingProduct").val(selectedItem.HilightingProduct);
                    $("#SBU").val(selectedItem.SBU);
                    $("#MarketGroup").val(selectedItem.MarketGroup);
                    $("#CostPerUnit").val(selectedItem.CostPerUnit);

                });

            });






        </script>



